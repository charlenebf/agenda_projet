name: D√©ploiement CI/CD sur Kubernetes

on:
  push:
    branches:
      - main # D√©clencher uniquement lors du push sur la branche 'main'

env:
  REGISTRY: ghcr.io
  # Les noms des images dans le registre (ex: ghcr.io/votre-org/votre-repo/backend)
  BACKEND_IMAGE_NAME: ${{ github.repository }}/backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}/frontend
  K8S_MANIFESTS_PATH: k8s # Ajout d'une variable pour le chemin des manifests

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # N√©cessaire pour pousser vers GHCR

    steps:
      - name: 1. Checkout du code
        uses: actions/checkout@v4

      - name: 2. Connexion au GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- BACKEND (LARAVEL) BUILD & PUSH ---

      - name: 3. D√©finir les tags pour l'image Backend
        id: backend_meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
          tags: |
            type=sha,prefix= # Utilise le SHA de commit comme tag
            type=raw,value=latest

      - name: 4. Construire et pousser l'image Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.backend_meta.outputs.tags }}
          labels: ${{ steps.backend_meta.outputs.labels }}

      # --- FRONTEND (ANGULAR/NGINX) BUILD & PUSH ---

      - name: 5. D√©finir les tags pour l'image Frontend
        id: frontend_meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
          tags: |
            type=sha,prefix= # Utilise le SHA de commit comme tag
            type=raw,value=latest

      - name: 6. Construire et pousser l'image Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.frontend_meta.outputs.tags }}
          labels: ${{ steps.frontend_meta.outputs.labels }}

      # --- DEPLOIEMENT KUBERNETES ---

      - name: 7. Configuration de Kubeconfig
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG_DATA }}

      - name: 8. Installation de kubectl
        uses: azure/setup-kubectl@v4
        id: install_kubectl # Ajout d'un ID pour r√©f√©rence future (bonne pratique)

      - name: 9. Patch/Substitution des images dans les manifests K8s
        # CRUCIAL : Remplace le tag "latest" par le tag SHA/GHCR
        run: |
          # Tag complet de l'image (ex: ghcr.io/monorg/monrepo/backend:SHA)
          BACKEND_FULL_IMAGE=${{ steps.backend_meta.outputs.tags }}
          FRONTEND_FULL_IMAGE=${{ steps.frontend_meta.outputs.tags }}

          echo "Mise √† jour de l'image Backend dans backend.yaml avec : $BACKEND_FULL_IMAGE"
          # Utilise 'sed' pour remplacer l'image "agenda-backend:latest"
          # par l'image compl√®te tagu√©e par SHA de GHCR.
          sed -i "s|image: agenda-backend:latest|image: $BACKEND_FULL_IMAGE|g" backend.yaml

          echo "Mise √† jour de l'image Frontend dans frontend.yaml avec : $FRONTEND_FULL_IMAGE"
          # Utilise 'sed' pour remplacer l'image "agenda-frontend:latest"
          # par l'image compl√®te tagu√©e par SHA de GHCR.
          sed -i "s|image: agenda-frontend:latest|image: $FRONTEND_FULL_IMAGE|g" frontend.yaml

      - name: 10. Application des manifests Kubernetes et Migrations
        # REMPLACER le script deploy.sh avec un encha√Ænement de commandes plus clair et sp√©cifique au CI/CD
        run: |
          echo "D√©ploiement K8s d√©marr√©..."
          
          # 1. Appliquer tous les manifests dans l'ordre de d√©pendance
          kubectl apply -f namespace.yaml
          kubectl apply -f mariadb.yaml
          kubectl apply -f backend.yaml
          kubectl apply -f frontend.yaml

          # 2. Attendre que la BDD soit pr√™te
          echo "‚è≥ Attente de MariaDB..."
          kubectl wait --for=condition=ready pod -l app=mariadb -n agenda --timeout=300s

          # 3. Attendre que le backend soit disponible (nouveau code)
          echo "‚è≥ Attente du backend..."
          kubectl wait --for=condition=available deployment/backend -n agenda --timeout=300s
          
          # 4. Ex√©cuter les migrations (CRUCIAL pour Laravel)
          echo "üóÑÔ∏è Ex√©cution des migrations..."
          # Note: Assurez-vous que le pod backend est bien d√©marr√© avant cette √©tape
          kubectl exec -n agenda deployment/backend -c backend -- php artisan migrate --force

          echo "‚úÖ D√©ploiement K8s termin√©."


      - name: 11. V√©rification finale du statut du d√©ploiement
        run: |
          # Correction : Le namespace est 'agenda' et non 'angenda'
          kubectl rollout status deployment/backend -n agenda
          kubectl rollout status deployment/frontend -n agenda